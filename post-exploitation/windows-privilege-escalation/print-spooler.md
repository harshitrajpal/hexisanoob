---
description: >-
  https://research.ifcr.dk/spoolfool-windows-print-spooler-privilege-escalation-cve-2022-22718-bf7752b68d81
---

# Print Spooler

TL;DR - These two vulnerabilities, CVE-2020–1048 and CVE-2020–1337, were patched in May and August 2020, respectively. In September 2020, Microsoft patched a different vulnerability in the Print Spooler. In short, this vulnerability allowed users to create arbitrary and writable directories by configuring the `SpoolDirectory` attribute on a printer. After the patch, the Print Spooler would now check if the user had permissions to create the directory before setting the `SpoolDirectory` property on a printer. Through SpoolFool exploit, we would allow users to have those permissions by letting him add a remote printer and using it's permissions to fool the spooler to gain privilege escalation.

### Background

Print spooler is abuilt in exe that is the primary interface of the printing process. It manages the printing process. It is loaded at the system startup and runs till it is shut down.

![](<../../.gitbook/assets/image (99).png>)

Application: The print application creates a print job by calling Graphics Device Interface (GDI).

GDI: GDI includes both user-mode and kernel-mode components for graphics support.

winspool.drv is the interface that talks to spooler. It provides the RPC stubs required to accessing the server.

spoolsv.exe is the spooler's API server. This module implements message routing to print provider with the help of router (spoolss.dll)

spoolss.dll determines which print provider to call, base don a printer name and passes function call ot the correct provider.

#### Print Provider

When a user prints a document, a print job is spooled to a predefined location referred to as the “spool directory”. The spool directory is configurable on each printer and it must allow the [`FILE_ADD_FILE`](https://docs.microsoft.com/en-us/windows/win32/fileio/file-access-rights-constants) permission to all users.

![](<../../.gitbook/assets/image (87).png>)

The Print Spooler provides APIs for managing configuration data such as `EnumPrinterData`, `GetPrinterData`, `SetPrinterData`, and `DeletePrinterData`. We can modify a printer’s configuration with `SetPrinterDataEx`. This function requires a printer to be opened with the `PRINTER_ACCESS_ADMINISTER` access right. If the current user doesn’t have permission to open an existing printer with the `PRINTER_ACCESS_ADMINISTER` access right, there are two options:

* The user can create a new local printer
* The user can add a remote printer

By default, users in the `INTERACTIVE` group have the “Manage Server” permission and can therefore create new local printers, as shown below.

![](<../../.gitbook/assets/image (55).png>)

Adding a local printer only works on windows 10 and 11 though as INTERACTIVE group is absent on windows servers, so, for servers, a user can add a remote printer!

Scenario:

* User adds a remote printer which would inherit the security properties of the shared printer server.
* So, if remote printer allows EVERYONE to manage the printer, then it is possible to obtain a handle to the printer with the PRINTER\__ACCESS\__ADMINISTER right.

Attack:

* User creates a shared printer on a different server and grants EVERYONE the right to manage printer
* Add this remote print server on the victim machine which can now be managed by EVERYONE.



